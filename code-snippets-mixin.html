<!--
@license
Copyright 2018 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/lib/utils/mixin.html">
<script>
(function() {
const URI_CACHE = {};
if (!window.ArcBehaviors) {
  /**
   * @namespace ArcBehaviors
   */
  window.ArcBehaviors = {};
}
/**
 * Common properties for HTTP code snippets.
 *
 * @polymer
 * @mixinFunction
 * @memberof ArcBehaviors
 */
ArcBehaviors.CodeSnippetsMixin = Polymer.dedupingMixin((base) => {
  /**
   * @polymer
   * @mixinClass
   */
  class CSmixin extends base {
    static get properties() {
      return {
        // The URL of the request
        url: String,
        // HTTP method
        method: String,
        // HTTP headers
        headers: String,
        // HTTP body (message)
        payload: String,
      };
    }
    /**
     * Computes a list of headers from a headers string.
     * @param {?String} headers
     * @return {Array} Headers as a list od maps. Can be empty.
     */
    headersToList(headers) {
      headers = headers || this.headers;
      if (!headers || !headers.trim() || typeof headers !== 'string') {
        return [];
      }
      const result = [];
      headers = headers.split(/\n(?=[^ \t]+)/gim);

      for (let i = 0, len = headers.length; i < len; i++) {
        const line = headers[i].trim();
        if (line === '') {
          continue;
        }
        const sepPosition = line.indexOf(':');
        if (sepPosition === -1) {
          result[result.length] = {
            name: line,
            value: ''
          };
          continue;
        }
        const name = line.substr(0, sepPosition);
        const value = line.substr(sepPosition + 1).trim();
        const obj = {
          name: name,
          value: value
        };
        result.push(obj);
      }
      return result;
    }
    /**
     * Reads the host, port and path from the url.
     * This function uses URI library to parse the URL so you have to
     * include this library from bower_components if the element want to use it.
     */
    urlDetails(url) {
      if (URI_CACHE[url]) {
        return URI_CACHE[url];
      }
      url = url || this.url;
      const result = {
        path: '',
        port: '',
        hostValue: ''
      };
      if (!url) {
        return result;
      }
      let uri;
      try {
        uri = new URL(url);
      } catch (e) {
        if (url[0] === '/') {
          result.path = url;
          result.post = 80;
        }
        return result;
      }
      let host = uri.hostname;
      if (host) {
        host = decodeURIComponent(host);
      }
      let port = uri.port;
      if (!port) {
        if (uri.protocol === 'https:') {
          port = 443;
        } else {
          port = 80;
        }
      }
      result.port = port;
      result.hostValue = host;

      const query = uri.search;
      let path = uri.pathname;
      if (!path) {
        path = '/';
      } else {
        path = decodeURIComponent(path);
      }
      if (query) {
        path += query;
      }
      result.path = path;
      URI_CACHE[url] = result;
      return result;
    }

    _copyToClipboard(e) {
      const button = e.currentTarget || e.target;
      const path = e.composedPath();
      let code;
      let node;
      let i = 0;
      while ((node = path[i])) {
        i++;
        if (!node || !node.nodeName) {
          continue;
        }
        if (node.nodeName === 'CODE') {
          code = node;
          break;
        }
      }
      if (!code) {
        return;
      }
      // From https://github.com/google/material-design-lite/blob/master/docs/_assets/snippets.js
      const snipRange = document.createRange();
      snipRange.selectNodeContents(code);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(snipRange);
      let result = false;
      try {
        result = document.execCommand('copy');
        button.icon = 'arc:done';
      } catch (err) {
        button.icon = 'arc:error';
      }
      setTimeout(() => {
        button.icon = 'arc:content-copy';
      }, 1000);
      selection.removeAllRanges();
    }
  }
  return CSmixin;
});
})();
</script>
