<script>
window.ArcBehaviors = window.ArcBehaviors || {};
/**
 * A common properties for HTTP code snippets.
 *
 * @polymerBehavior ArcBehaviors.HttpCodeSnippetBehavior
 */
ArcBehaviors.HttpCodeSnippetBehavior = {
  properties: {
    // The URL of the request
    url: String,
    // HTTP method
    method: String,
    // HTTP headers
    headers: {
      type: String,
      value: false
    },
    // HTTP body (message)
    payload: {
      type: String,
      value: false
    }
  },

  headersToList: function(headers) {
    headers = headers || this.headers;
    if (!headers || !headers.trim()) {
      return [];
    }
    return headers.split('\n').map(function(line) {
      var parts = line.split(':');
      for (var i in parts) {
        parts[i] = parts[i].trim();
      }
      return {
        name: parts[0],
        value: parts[1] || ''
      };
    });
  },
  /**
   * Reads the host, port and path from the url.
   * This function uses URI library to parse the URL so you have to
   * include this library from bower_components if the element want to use it.
   */
  urlDetails: function(url) {
    url = url || this.url;
    var result = {
      path: '',
      port: '',
      hostValue: ''
    };
    if (!url) {
      return result;
    }

    var uri = new URI(url);
    var host = uri.hostname();
    var port = uri.port();
    if (!port) {
      if (uri.protocol() === 'https') {
        port = 443;
      } else {
        port = 80;
      }
    }
    result.port = port;
    result.hostValue = host;

    var query = uri.query();
    var path = uri.path();
    if (!path) {
      path = '/';
    }
    if (query) {
      path += '?' + query;
    }
    result.path = path;

    return result;
  },

  _copyToClipboard: function(e) {
    e = Polymer.dom(e);
    var button = e.localTarget;
    var code;
    var node;
    var i = 0;
    while ((node = e.path[i])) {
      i++;
      if (!node || !node.nodeName) {
        continue;
      }
      if (node.nodeName === 'CODE') {
        code = node;
        break;
      }
    }
    if (!code) {
      return;
    }
    // From https://github.com/google/material-design-lite/blob/master/docs/_assets/snippets.js
    var snipRange = document.createRange();
    snipRange.selectNodeContents(code);
    var selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(snipRange);
    var result = false;
    try {
      result = document.execCommand('copy');
      button.icon = 'httpsnippets:done';
    } catch (err) {
      // Copy command is not available
      Polymer.Base._error(err);
      button.icon = 'error';
    }
    // Return to the copy button after a second.
    setTimeout(this._resetCopyButtonState.bind(this, button), 1000);
    selection.removeAllRanges();
    return result;
  },
  _resetCopyButtonState: function(button) {
    button.icon = 'httpsnippets:content-copy';
  }
};
</script>
